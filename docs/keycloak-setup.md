# 🔐 Keycloak Setup Guide for evtechallenge

This guide provides step-by-step instructions for setting up Keycloak authentication with the evtechallenge API system.

## 📋 Prerequisites

- Docker and Docker Compose installed
- Access to the evtechallenge project

## 🚀 Quick Start

### 1. Start the Services

```bash
# Start Keycloak and setup services
docker-compose up -d keycloak keycloak-setup

# Wait for services to be ready
docker-compose ps
```

The setup script runs automatically in the `keycloak-setup` container and will:
- ✅ Check Keycloak health (using internal Docker networking)
- ✅ Create the `evtechallenge` realm
- ✅ Create the `api-client` client with auto-generated secret
- ✅ Create test users `tenant1` and `tenant2` with passwords from `env.model`
- ✅ Test authentication

## 🏗️ Manual Setup (Alternative)

If you prefer to set up Keycloak manually or the script fails:

### 1. Access Keycloak Admin Console

- **URL**: http://localhost:8082
- **Username**: `admin`
- **Password**: `admin`

### 2. Create a New Realm

1. Click "Add realm" button
2. **Realm name**: `evtechallenge`
3. Click "Create"

### 3. Create a New Client

1. Go to "Clients" in left sidebar
2. Click "Create" button
3. **Client ID**: `api-client`
4. **Client Protocol**: `openid-connect`
5. **Root URL**: `http://localhost:8080`
6. Click "Save"

### 4. Configure Client Settings

1. **Client authentication**: Turn ON ✅
2. **Direct access grants only**: Turn ON ✅
3. **Standard flow**: Turn OFF ❌
4. **Valid redirect URIs**: `http://localhost:8080/*`
5. **Web origins**: `http://localhost:8080`
6. Click "Save"

### 5. Get Client Secret

1. Go to "Credentials" tab
2. Copy the "Secret" value
3. **Save it for API testing**

### 6. Create a User

1. Go to "Users" in left sidebar
2. Click "Add user" button
3. **Username**: `tenant1`
4. **Email**: `tenant1@example.com`
5. **First Name**: `Tenant`
6. **Last Name**: `One`
7. Click "Save"

### 7. Set User Password

1. Go to "Credentials" tab
2. **Set Password**: `tnt1` (from `env.model`)
3. **Temporary**: Turn OFF ❌
4. Click "Set Password"

## 🧪 Testing Authentication

### 1. Get Access Token (from Docker container)

```bash
# Run from inside the keycloak-setup container
docker-compose exec keycloak-setup curl -X POST http://keycloak:8080/realms/evtechallenge/protocol/openid-connect/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=api-client" \
  -d "client_secret=YOUR_CLIENT_SECRET" \
  -d "username=tenant1" \
  -d "password=tnt1"
```

**Note**: The setup script automatically retrieves and displays the client secret. Look for it in the container logs:
```bash
docker-compose logs keycloak-setup
```

**Expected Response:**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 300,
  "refresh_expires_in": 1800,
  "refresh_token": "...",
  "token_type": "Bearer",
  "scope": "openid profile email"
}
```

### 2. Test API Endpoint (from Docker container)

```bash
# Run from inside the keycloak-setup container
docker-compose exec keycloak-setup curl -X GET http://api-rest:8080/api/tenant1/patients \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**Note**: Use internal Docker service names (`keycloak:8080`, `api-rest:8080`) when running from containers.

## 📊 Configuration Details

### Keycloak Realm Configuration

- **Realm Name**: `evtechallenge`
- **Access Token Lifespan**: 5 minutes
- **Refresh Token Lifespan**: 30 minutes
- **SSO Session Idle Timeout**: 30 minutes
- **SSO Session Max Lifespan**: 10 hours

### Client Configuration

- **Client ID**: `api-client`
- **Client Type**: Confidential
- **Authentication**: Enabled
- **Direct Access Grants**: Enabled
- **Standard Flow**: Disabled
- **Valid Redirect URIs**: `http://localhost:8080/*`
- **Web Origins**: `http://localhost:8080`

### Default Scopes

- `openid` - OpenID Connect
- `profile` - User profile information
- `email` - User email address
- `offline_access` - Refresh tokens (optional)

## 🔧 Environment Variables

The following environment variables are configured in `env.model`:

```bash
# Keycloak Configuration (internal Docker networking)
KEYCLOAK_URL=http://keycloak:8080
KEYCLOAK_REALM=evtechallenge
KEYCLOAK_CLIENT_ID=api-client
KEYCLOAK_CLIENT_SECRET=  # Auto-generated by setup script

# Tenant Configuration
TENANT1_USERNAME=tenant1
TENANT1_PASSWORD=tnt1
TENANT2_USERNAME=tenant2
TENANT2_PASSWORD=tnt2

# API Configuration
API_PORT=8080
API_LOG_LEVEL=info
```

**Note**: The `KEYCLOAK_URL` uses internal Docker networking (`keycloak:8080`) for service-to-service communication, while external access is via `localhost:8082`.

## 🚨 Troubleshooting

### Common Issues

#### 1. Keycloak Not Ready
**Error**: `Keycloak is not responding`
**Solution**: Wait for Keycloak to fully start (usually 30-60 seconds)

```bash
# Check Keycloak health from container
docker-compose exec keycloak-setup curl http://keycloak:9000/health/ready
```

#### 2. Authentication Failed
**Error**: `Invalid token` or `Unauthorized`
**Solution**: Check client secret and user credentials

```bash
# Check setup script logs for client secret
docker-compose logs keycloak-setup | grep -i "client secret"

# Verify client secret from container
docker-compose exec keycloak-setup curl -X GET http://keycloak:8080/admin/realms/evtechallenge/clients \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

#### 3. Token Expired
**Error**: `Token expired`
**Solution**: Get a new access token

```bash
# Refresh token from container
docker-compose exec keycloak-setup curl -X POST http://keycloak:8080/realms/evtechallenge/protocol/openid-connect/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=refresh_token" \
  -d "client_id=api-client" \
  -d "client_secret=YOUR_CLIENT_SECRET" \
  -d "refresh_token=YOUR_REFRESH_TOKEN"
```

#### 4. Tenant Not Found
**Error**: `Tenant not ready or collection not initialized`
**Solution**: Ensure the tenant exists in Keycloak and the JWT token is valid

```bash
# Verify tenant exists in Keycloak from container
docker-compose exec keycloak-setup curl -X GET http://keycloak:8080/admin/realms/evtechallenge/users \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### Debug Commands

```bash
# Check service status
docker-compose ps

# View Keycloak logs
docker-compose logs -f keycloak

# View setup script logs
docker-compose logs -f keycloak-setup

# View API logs
docker-compose logs -f api-rest

# Test Keycloak connectivity from container
docker-compose exec keycloak-setup curl -v http://keycloak:8080/realms/evtechallenge/.well-known/openid_configuration

# Test external Keycloak connectivity (from host)
curl -v http://localhost:8082/realms/evtechallenge/.well-known/openid_configuration
```

## 📈 Monitoring

### Health Checks

- **Keycloak Health**: `http://localhost:8082/health/ready`
- **API Health**: `http://localhost:8080/health`
- **Metrics**: `http://localhost:8080/metrics`

### Logs

- **Keycloak Logs**: `docker-compose logs -f keycloak`
- **API Logs**: `docker-compose logs -f api-rest`
- **Couchbase Logs**: `docker-compose logs -f couchbase`

## 📋 Postman Collection Setup

### Step 1: Import the Collection
1. Open Postman
2. Click **"Import"** button
3. Select the `postman/evt-iam-collection.json` file
4. The collection will be imported with all requests and environment variables

### Step 2: Create Environment Variables for Token Storage
1. In Postman, click **"Environments"** in the left vertical toolbar
2. Click **"Create Environment"** or **"+"** button
3. Name it: `EVTeChallenge Local`
4. Add only these token storage variables:

| Variable | Initial Value | Current Value |
|----------|---------------|---------------|
| `access_token` | (leave empty) | (will be set automatically) |
| `refresh_token` | (leave empty) | (will be set automatically) |
| `token_expires_at` | (leave empty) | (will be set automatically) |

**Note**: All other variables (base_url, keycloak_url, realm, client_id, client_secret, username, password) are already configured in the imported collection's "variables in request" section.

### Step 3: Update Client Secret in Collection
1. Go to Keycloak Admin Console: http://localhost:8082
2. Login with `admin` / `admin`
3. Select `evtechallenge` realm
4. Go to **"Clients"** → **"api-client"** → **"Credentials"** tab
5. Copy the **"Secret"** value
6. In Postman, go to the **"Get Access Token"** request
7. In the request body, find the `client_secret` field and replace `YOUR_CLIENT_SECRET_HERE` with the actual secret value

### Step 4: Select Your Environment
1. In the top-right corner of Postman, click the environment dropdown
2. Select **"EVTeChallenge Local"** (or whatever you named it)
3. You should see `{{base_url}}`, `{{keycloak_url}}`, etc. in the request URLs (these come from the collection's "variables in request")
4. The environment variables you created are only for storing tokens (`{{access_token}}`, `{{refresh_token}}`, `{{token_expires_at}}`)

### Step 5: Test Authentication
1. Run the **"Get Access Token"** request first
2. This will automatically set `access_token` and `refresh_token` in your environment
3. All other requests will automatically use these tokens

## 🔄 Automatic Token Renewal

The collection includes automatic JWT token renewal using refresh tokens. Here's how it works:

### Pre-request Script (automatically added to all business requests)
```javascript
// Check if token is expired or missing
const currentToken = pm.environment.get("access_token");
const tokenExpiresAt = pm.environment.get("token_expires_at");
const refreshToken = pm.environment.get("refresh_token");

// If token is expired or missing, try to refresh it
if (!currentToken || !tokenExpiresAt || Date.now() > tokenExpiresAt) {
    console.log("Token expired or missing, attempting refresh...");
    
    if (refreshToken) {
        // Try refresh token first
        pm.sendRequest({
            url: pm.environment.get("keycloak_url") + "/realms/" + pm.environment.get("realm") + "/protocol/openid-connect/token",
            method: "POST",
            header: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: {
                mode: "urlencoded",
                urlencoded: [
                    { key: "grant_type", value: "refresh_token" },
                    { key: "client_id", value: pm.environment.get("client_id") },
                    { key: "client_secret", value: pm.environment.get("client_secret") },
                    { key: "refresh_token", value: refreshToken }
                ]
            }
        }, function (err, response) {
            if (err || response.code !== 200) {
                console.log("Refresh token failed, falling back to password grant...");
                // Fallback to password grant
                pm.sendRequest({
                    url: pm.environment.get("keycloak_url") + "/realms/" + pm.environment.get("realm") + "/protocol/openid-connect/token",
                    method: "POST",
                    header: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: {
                        mode: "urlencoded",
                        urlencoded: [
                            { key: "grant_type", value: "password" },
                            { key: "client_id", value: pm.environment.get("client_id") },
                            { key: "client_secret", value: pm.environment.get("client_secret") },
                            { key: "username", value: pm.environment.get("username") },
                            { key: "password", value: pm.environment.get("password") }
                        ]
                    }
                }, function (err2, response2) {
                    if (err2 || response2.code !== 200) {
                        console.error("Authentication failed:", response2.text());
                        return;
                    }
                    
                    const tokenData = response2.json();
                    pm.environment.set("access_token", tokenData.access_token);
                    pm.environment.set("refresh_token", tokenData.refresh_token);
                    pm.environment.set("token_expires_at", Date.now() + (tokenData.expires_in * 1000));
                    console.log("New tokens obtained via password grant");
                });
            } else {
                const tokenData = response.json();
                pm.environment.set("access_token", tokenData.access_token);
                pm.environment.set("refresh_token", tokenData.refresh_token);
                pm.environment.set("token_expires_at", Date.now() + (tokenData.expires_in * 1000));
                console.log("Tokens refreshed successfully");
            }
        });
    } else {
        console.error("No refresh token available and current token is expired!");
    }
}

// Set Authorization header for the current request
pm.request.headers.add({
    key: "Authorization",
    value: "Bearer " + pm.environment.get("access_token")
});

// Set X-Tenant-ID header
pm.request.headers.add({
    key: "X-Tenant-ID",
    value: pm.environment.get("username")
});
```

### How to Use Environment Variables
- When you hover over `{{base_url}}` in a request, you'll see "variables in request"
- The actual values are stored in your environment and can be edited in the "Environments" section
- All `{{variable_name}}` placeholders will be automatically replaced with their values

## 🔒 Security Considerations

### Production Setup

1. **Change Default Passwords**
   - Update admin password
   - Use strong client secrets
   - Rotate secrets regularly

2. **Network Security**
   - Use HTTPS in production
   - Configure proper firewall rules
   - Use VPN for admin access

3. **Token Security**
   - Use short-lived access tokens
   - Implement token rotation
   - Monitor for token abuse

4. **Audit Logging**
   - Enable Keycloak audit logs
   - Monitor authentication events
   - Set up alerting for failures

## 📚 Additional Resources

- [Keycloak Documentation](https://www.keycloak.org/documentation)
- [OpenID Connect Specification](https://openid.net/connect/)
- [JWT.io](https://jwt.io/) - JWT token decoder
- [Postman Collection](./postman/) - API testing collection

## 🤝 Support

For issues or questions:
1. Check the troubleshooting section above
2. Review the logs for error messages
3. Test with the provided Postman collection
4. Contact the development team

---

*This guide is part of the evtechallenge project documentation.*
